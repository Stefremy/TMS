<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Stages - 60 Months</title>
    <meta name="description" content="Projeção financeira de 60 meses com fases de investimento, receitas e margens — visão para investidores.">
    <meta name="theme-color" content="#667eea">
    <meta property="og:title" content="Cenário Real - Fases de Investimento (60 Meses)">
    <meta property="og:description" content="Projeção financeira de 60 meses com fases de investimento, receitas e margens — visão para investidores.">
    <meta property="og:type" content="website">
    <style>
        /* Assumptions panel styling */
        .assumptions { background: linear-gradient(180deg,#ffffff,#fbfcff); padding:12px 14px; border-radius:10px; border:1px solid rgba(2,6,23,0.04); box-shadow: 0 8px 20px rgba(15,23,42,0.03); }
        .assumptions h3{ margin:0 0 8px 0; font-size:1.02rem; color:#0b1220 }
    /* assumptions layout: grouped and responsive grid */
    .assumptions-grid{ display:grid; grid-template-columns: repeat(2, minmax(220px,1fr)); gap:10px; align-items:start; }
    .ass-group { background: transparent; padding:8px; border-radius:10px; }
    .ass-group strong { display:block; margin-bottom:6px; color:#0f172a; font-size:0.95rem; }
    .assumptions-grid label{ display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; transition: transform .12s ease, box-shadow .12s ease; }
    .assumptions-grid label:hover{ transform: translateY(-3px); box-shadow: 0 8px 20px rgba(2,6,23,0.05); }
        /* collapsible group styles */
        .ass-group .collapse-btn{ background:transparent; border:0; font-weight:700; float:right; cursor:pointer; color:#334155; margin-left:8px; }
        .ass-group .help-text{ margin:6px 0 8px 0; color:#475569; font-size:0.88rem; }
        .ass-group .group-body{ transition: max-height 0.22s ease, opacity 0.2s linear; overflow:hidden; }
        .ass-group.collapsed .group-body{ max-height:0 !important; opacity:0; padding:0; margin:0; }
        .ass-group .group-body label{ display:block; margin-bottom:6px; }
        .assumptions-grid input[type="number"]{ width:110px; padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,42,0.08); background: white; font-weight:700; text-align:right; }
        .assumptions-grid input[type="checkbox"]{ width:auto; transform:scale(1.05); }
        .assumptions-grid label small{ color:#475569; display:block; font-size:0.78rem; }
        .assumptions-grid input[type=number]:focus{ outline:none; box-shadow: 0 6px 18px rgba(99,102,241,0.08); border-color: rgba(99,102,241,0.24); }
        /* hide default spinner on number inputs for better aesthetics */
        input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { appearance:textfield; -moz-appearance:textfield; }
        /* page base */
        body {
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: linear-gradient(180deg, #f0f4ff 0%, #f7fbff 100%);
            padding: 28px;
            margin: 0;
            color: #0f172a;
            -webkit-font-smoothing: antialiased;
            line-height: 1.45;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 14px;
            padding: 32px;
            box-shadow: 0 12px 40px rgba(17,24,39,0.08);
        }

        h1 { color: #0f172a; margin: 0 0 10px 0; font-size: 1.4rem; }
        .subtitle { color: #475569; margin-bottom: 10px; }

        .topbar { display:flex; gap:10px; align-items:center; margin-bottom:18px; }
        .btn { padding:10px 14px; border-radius:10px; border:1px solid rgba(2,6,23,0.06); background:white; cursor:pointer; font-weight:600; }
        .btn.active { background:#4f46e5; color:white; border-color:transparent; box-shadow: 0 6px 18px rgba(79,70,229,0.12); }

        /* table */
        table { width:100%; border-collapse:collapse; margin-bottom:18px; border-radius:8px; overflow:hidden; }
        thead { background: #f8fafc; }
        th { padding:12px 12px; text-align:left; font-weight:700; color:#0f172a; font-size:0.95rem; border-bottom:1px solid #eef2ff; }
        td { padding:12px 12px; border-bottom:1px solid #f1f5f9; vertical-align:middle; font-size:0.95rem; }
        tbody tr:nth-child(even) td { background: #fbfdff; }

        /* numeric columns: right align and tabular numbers for consistent widths */
        .num { text-align: right; font-variant-numeric: tabular-nums; }

        .metric { font-weight:700; }
        .positive { color: #056a44; }
        .negative { color: #8b1d1d; }

        /* phase header that appears inside the table */
        .stage-header {
            padding:14px 16px;
            border-radius:8px;
            background: linear-gradient(90deg,#3b82f6 0%, #7c3aed 100%);
            margin:14px 0 10px 0;
            font-weight:800;
            color:white;
            font-size:1rem;
            box-shadow: 0 8px 28px rgba(59,130,246,0.08);
            border-left:6px solid rgba(255,255,255,0.14);
        }

        /* inline phase summary row styling (applied to the td that spans the table) */
        td.summary-box {
            background: #f8fafc;
            border-left: 6px solid #4f46e5;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(79,70,229,0.06);
        }

        .summary-box { background:#f8fafc; padding:12px; border-radius:8px; margin-bottom:12px; }
        /* positive / negative summary states */
        .summary-positive { border-left-color: #059669; background: linear-gradient(90deg, rgba(6,182,129,0.04), rgba(6,182,129,0.02)); }
        .summary-negative { border-left-color: #dc2626; background: linear-gradient(90deg, rgba(220,38,38,0.04), rgba(220,38,38,0.02)); }
        .summary-positive .key-metric strong.positive { color:#065f46; }
        .summary-negative .key-metric strong.negative { color:#7f1d1d; }
        .key-metric { margin-right:14px; display:inline-flex; align-items:center; gap:8px; color:#0f172a; }

        .rev-prebreakeven { 
            background: #ffffff; /* warmer yellow */
            border-left: 4px solid #f59e0b; /* amber accent */
            padding:6px 8px; 
            border-radius:6px; 
            color: #92400e; 
            font-weight:700;
        }
        /* break-even month emphasis */
        .rev-break { box-shadow: 0 4px 18px rgba(245,158,11,0.12); border-left-width:6px; }
        .highlight td { background:#fbfdff; }

        #all-error { display:none; }
        @media print { .topbar, .btn { display:none; } }
    /* logo area (moved to topbar) */
    .page-logo-left { display:inline-flex; align-items:center; margin-left:6px; }
    .page-logo-left a { display:inline-block; line-height:1; }
    .page-logo-left img#top-logo { height:40px; width:auto; display:block; filter: drop-shadow(0 6px 16px rgba(2,6,23,0.06)); }
    @media (max-width:520px){ .page-logo-left img#top-logo { height:34px; } }
    @media print { .page-logo-left { display:none; } }
    /* fixed-cost tooltip styling */
    .fixed-cell { position:relative; cursor:help; }
    .fixed-cell:hover::after{
        content: attr(data-tooltip);
        position:absolute; left:50%; transform:translateX(-50%); top:calc(100% + 10px);
        background: #0b1220; color: #fff; padding:8px 10px; border-radius:8px; white-space:nowrap; font-size:0.85rem; z-index:30; box-shadow:0 10px 30px rgba(2,6,23,0.18);
    }
    .team-cell { position:relative; cursor:help; }
    .team-cell:hover::after{
        content: attr(data-tooltip);
        position:absolute; left:50%; transform:translateX(-50%); top:calc(100% + 10px);
        background: #0b1220; color: #fff; padding:8px 10px; border-radius:8px; white-space:nowrap; font-size:0.85rem; z-index:30; box-shadow:0 10px 30px rgba(2,6,23,0.18);
    }
    .invest-cell { position:relative; cursor:help; }
    .invest-cell:hover::after{
        content: attr(data-tooltip);
        position:absolute; left:50%; transform:translateX(-50%); top:calc(100% + 10px);
        background: #0b1220; color: #fff; padding:8px 10px; border-radius:8px; white-space:nowrap; font-size:0.85rem; z-index:30; box-shadow:0 10px 30px rgba(2,6,23,0.18);
    }
    .marketing-cell { position:relative; cursor:help; }
    .marketing-cell:hover::after{
        content: attr(data-tooltip);
        position:absolute; left:50%; transform:translateX(-50%); top:calc(100% + 10px);
        background: #0b1220; color: #fff; padding:8px 10px; border-radius:8px; white-space:nowrap; font-size:0.85rem; z-index:30; box-shadow:0 10px 30px rgba(2,6,23,0.18);
    }
    .op-cell { position:relative; cursor:help; }
    .op-cell:hover::after{
        content: attr(data-tooltip);
        position:absolute; left:50%; transform:translateX(-50%); top:calc(100% + 10px);
        background: #0b1220; color: #fff; padding:8px 10px; border-radius:8px; white-space:nowrap; font-size:0.85rem; z-index:30; box-shadow:0 10px 30px rgba(2,6,23,0.18);
    }
    </style>
    <style>
        /* summary size modes */
        /* (summary size modes removed) */
        /* active state for toggle buttons */
        .btn.toggled { background:#111827; color:white; }
    </style>
    <style>
        /* Polished styling for the vertical summary box */
        .summary-box.summary-vertical {
            padding: 18px;
            border-radius: 12px;
            background: linear-gradient(180deg, #ffffff, #f8fbff);
            border: 1px solid rgba(99,102,241,0.06);
            box-shadow: 0 12px 30px rgba(2,6,23,0.06);
            margin-top: 8px;
        }
        .summary-box.summary-vertical h3 { margin: 0 0 10px 0; font-size: 1.05rem; color: #0f172a; }
        .summary-rows { margin-top: 6px; }
        .summary-row{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
            padding:8px 10px;
            border-radius:8px;
            transition: background .18s ease, transform .08s ease;
        }
        .summary-row:not(:last-child){ border-bottom: 1px solid rgba(15,23,42,0.04); }
        .summary-row:hover{ background: rgba(99,102,241,0.02); }
        .summary-row .small { color: #475569; font-size:0.92rem; }
        .summary-row .metric { text-align:right; font-weight:700; color:#0f172a; min-width:160px; }
        .summary-row .metric strong{ font-size:1rem; }

        /* net states */
        .summary-row .metric.positive strong{ color:#059669; }
        .summary-row .metric.negative strong{ color:#dc2626; }

        /* break-even emphasis */
        .summary-row.break { 
            background: linear-gradient(90deg,#fff7e6, #fff4e1); 
            border-left: 6px solid #f59e0b; 
            box-shadow: 0 10px 30px rgba(245,158,11,0.09);
            transform: translateY(-1px);
        }
        .summary-row.break .metric strong{ color:#92400e; font-weight:900; font-size:1.08rem; }

        /* accumulated net prominence */
        .summary-row.net-prominent { 
            background: linear-gradient(90deg,#f0fff4, #f7fffb);
            border-left: 6px solid rgba(5,150,105,0.9);
            box-shadow: 0 10px 30px rgba(6,182,129,0.06);
            transform: translateY(-1px);
        }
        .summary-row.net-prominent .metric strong{ font-size:1.18rem; font-weight:900; letter-spacing:0.2px; }
        .summary-row .metric.prominent.positive strong{ color:#059669; }
        .summary-row .metric.prominent.negative strong{ color:#dc2626; }

    /* ROI styling */
    .summary-row .metric #all-roi { font-size:1.02rem; }
    .summary-row .metric.positive #all-roi { color: #059669; font-weight:800; }
    .summary-row .metric.negative #all-roi { color: #dc2626; font-weight:800; }

        @media (max-width:780px){
            .summary-row { flex-direction:column; align-items:flex-start; }
            .summary-row .metric{ width:100%; text-align:left; margin-top:6px; }
        }
    </style>
    </head>
    <body>
        <div class="container">
            <div class="topbar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="btn active" id="btn-all">SaaS</button>
                    <div class="page-logo-left" aria-hidden="true">
                        <a href="https://www.linke.pt" target="_blank" rel="noopener noreferrer" aria-label="Link to linke.pt">
                            <img src="noBgColor (1).png" alt="Logo" id="top-logo">
                        </a>
                    </div>
                </div>
                <div style="flex:1"></div>
                <button class="btn active" id="btn-view-allinone" title="Ver All in One">All in One</button>
                <button class="btn" id="btn-view-tms" title="Ver TMS">TMS</button>
                
                <button class="btn" id="btn-print">Imprimir / Salvar PDF</button>
            </div>

            <div id="view-all">
                <h1>All in One — Cenário</h1>
    

                <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
                    <button class="btn" id="export-csv">Export CSV</button>
                    <div style="flex:1"></div>
                </div>

                <div id="all-error" style="display:none; background:#ffe3e3; border-left:4px solid #e53e3e; padding:10px; margin-bottom:12px; border-radius:6px;">
                    <strong>Erro:</strong> <span id="all-error-msg"></span>
                </div>

                <div class="assumptions" style="margin-bottom:12px;">
                    <h3>Assumptions (editáveis)</h3>
                    <div class="assumptions-grid">
                        <div class="ass-group" data-group="clients">
                            <strong>Receita & Clientes <button class="collapse-btn" aria-expanded="true" aria-label="Recolher/Expandir">▾</button></strong>
                            <p class="help-text">Defina o ticket médio, quando os clientes começam a entrar e o modelo de crescimento.</p>
                            <div class="group-body">
                                <label>Ticket médio: <input id="ass-ticket" type="number" value="85.66" step="0.01"></label>
                                <label>Mês em que começam a entrar clientes: <input id="ass-clients-start" type="number" value="6" min="1" max="60"></label>
                                <label>Clientes iniciais no 1º mês: <input id="ass-clients-init" type="number" value="100" step="1" min="0"></label>
                                <label>% Crescimento mensal (composto): <input id="ass-clients-growth" type="number" value="10" step="0.1" min="0"></label>
                                <label style="display:flex;align-items:center;gap:6px;">Usar modelo de crescimento: <input id="ass-clients-growth-mode" type="checkbox" title="Crescimento composto do mês anterior"></label>
                            </div>
                        </div>
                        <div class="ass-group" data-group="costs">
                            <strong>Custos <button class="collapse-btn" aria-expanded="true" aria-label="Recolher/Expandir">▾</button></strong>
                            <p class="help-text">Inclui custos operacionais por cliente e custos fixos mensais (servidores, renda, contabilidade, AI).</p>
                            <div class="group-body">
                                <label>Custo op / cliente: <input id="ass-op" type="number" value="60" step="0.01"></label>
                                <label>Custos fixos /m: <input id="ass-fixed" type="number" value="1250" step="1"></label>
                            </div>
                        </div>
                        <div class="ass-group" data-group="team">
                            <strong>Equipa <button class="collapse-btn" aria-expanded="true" aria-label="Recolher/Expandir">▾</button></strong>
                            <p class="help-text">Custo mensal da equipa (ex.: 2 comerciais + 2 apoio ao cliente).</p>
                            <div class="group-body">
                                <label>Custos equipa /m: <input id="ass-team" type="number" value="6000" step="1"></label>
                                <label>Equipa inicia em mês: <input id="ass-team-start" type="number" value="15" min="1" max="60"></label>
                            </div>
                        </div>
                        <div class="ass-group" data-group="invest">
                            <strong>Investimento <button class="collapse-btn" aria-expanded="true" aria-label="Recolher/Expandir">▾</button></strong>
                            <p class="help-text">Investimento em desenvolvimento da plataforma/website — valor mensal e duração.</p>
                            <div class="group-body">
                                <label>Investimento mensal (plataforma): <input id="ass-invest" type="number" value="14750" step="1"></label>
                                <label>Investimento até mês: <input id="ass-invest-end" type="number" value="16" min="1" max="60"></label>
                            </div>
                        </div>
                        <div class="ass-group" data-group="marketing">
                            <strong>Marketing <button class="collapse-btn" aria-expanded="true" aria-label="Recolher/Expandir">▾</button></strong>
                            <p class="help-text">Orçamento mensal de marketing e janela temporal.</p>
                            <div class="group-body">
                                <label>Marketing /m: <input id="ass-marketing" type="number" value="5000" step="1"></label>
                                <label>Marketing start: <input id="ass-marketing-start" type="number" value="17" min="1" max="60"></label>
                                <label>Marketing end: <input id="ass-marketing-end" type="number" value="22" min="1" max="60"></label>
                            </div>
                        </div>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Mês</th>
                            <th class="num">Clientes</th>
                            <th class="num">Receita Mensal</th>
                            <th class="num">Investimento</th>
                            <th class="num">Custos Fixos</th>
                            <th class="num">Custos Equipa</th>
                            <th class="num">Marketing</th>
                            <th class="num th-op">Custos Operação</th>
                            <th class="num">Total Custos</th>
                            <th class="num">Resultado Mensal</th>
                        </tr>
                    </thead>
                    <tbody id="all-tbody"></tbody>
                </table>
                <div class="summary-box summary-vertical">
                    <h3>Resumo All-in-One - 60 meses</h3>
                    <div class="summary-rows" style="display:flex; flex-direction:column; gap:10px; margin-top:8px;">
                        <div class="summary-row"><div class="small">Receita Total:</div><div class="metric"><strong id="all-total-rev">-</strong></div></div>
                        <div class="summary-row"><div class="small">Custos Operação Total:</div><div class="metric"><strong id="all-total-op">-</strong></div></div>
                        <div class="summary-row"><div class="small">Custos Fixos Total:</div><div class="metric"><strong id="all-total-fixed">-</strong></div></div>
                        <div class="summary-row"><div class="small">Custos Totais:</div><div class="metric"><strong id="all-total-costs">-</strong></div></div>
                        <div class="summary-row"><div class="small">Investimento Total:</div><div class="metric"><strong id="all-total-invest">-</strong></div></div>
                        <div class="summary-row"><div class="small">Custos Equipa Total:</div><div class="metric"><strong id="all-total-team">-</strong></div></div>
                        <div class="summary-row"><div class="small">Investimento Marketing Total:</div><div class="metric"><strong id="all-total-marketing">-</strong></div></div>
                        <div class="summary-row"><div class="small">Lucro Líquido Acumulado:</div><div class="metric"><strong id="all-net">-</strong></div></div>
                        <div class="summary-row"><div class="small">Break-Even:</div><div class="metric"><strong id="all-break">-</strong></div></div>
                        <div class="summary-row"><div class="small">ROI (Retorno / Investimento):</div><div class="metric"><strong id="all-roi">-</strong></div></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        // Clean All-in-One generator + wiring
        (function(){
            const keypoints = [
                {m:1, c:0}, {m:5, c:0}, {m:6, c:100}, {m:7, c:113}, {m:8, c:125}, {m:14, c:200},
                {m:15, c:213}, {m:16, c:225}, {m:17, c:238}, {m:18, c:250}, {m:20, c:275}, {m:22, c:300},
                {m:25, c:338}, {m:30, c:400}, {m:31, c:421}, {m:35, c:504}, {m:40, c:608}, {m:42, c:650},
                {m:45, c:688}, {m:46, c:700}, {m:50, c:750}, {m:54, c:800}, {m:60, c:875}
            ];

            const phases = [
                {start:1, end:16, title:'FASE 1: Desenvolvimento da Plataforma (M1-M16)'},
                {start:17, end:30, title:'FASE 2: Aceleração e Marketing (M17-M30)'},
                {start:31, end:45, title:'FASE 3: Crescimento Acelerado (M31-M45)'},
                {start:46, end:60, title:'FASE 4: Maturidade e Alta Rentabilidade (M46-M60)'}
            ];

            function interpClients(month){
                // if clientsStart is configured, do not count clients before that month
                if(assumptions && typeof assumptions.clientsStart !== 'undefined'){
                    if(month < assumptions.clientsStart) return 0;
                }
                // if growth mode is enabled, use geometric growth from clientsInit with clientsGrowth percent
                if(assumptions && assumptions.clientsGrowthMode){
                    const start = Math.max(1, assumptions.clientsStart || 1);
                    if(month < start) return 0;
                    const monthsSince = month - start;
                    const rate = (assumptions.clientsGrowth || 0) / 100;
                    // compound growth: init * (1+rate)^monthsSince
                    return Math.round((assumptions.clientsInit || 0) * Math.pow(1 + rate, monthsSince));
                }
                let left = keypoints[0];
                let right = keypoints[keypoints.length-1];
                for(let i=0;i<keypoints.length;i++){
                    if(keypoints[i].m === month) return keypoints[i].c;
                    if(keypoints[i].m < month) left = keypoints[i];
                    if(keypoints[i].m > month){ right = keypoints[i]; break; }
                }
                if(month <= left.m) return left.c;
                if(month >= right.m) return right.c;
                const ratio = (month - left.m) / (right.m - left.m);
                return Math.round(left.c + ratio * (right.c - left.c));
            }

            function fmt(v){ return Number(v).toLocaleString('pt-PT', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' €'; }

            const assumptions = {};
            // current UI mode: 'all' (default) or 'tms'
            let uiMode = 'all';
            function readAssumptionsFromUI(){
                const get = id => document.getElementById(id);
                function readNumber(id, isInt){
                    const el = get(id);
                    if(!el) return 0;
                    const v = el.value;
                    if(v === null || v === '') return 0;
                    const n = isInt ? parseInt(v, 10) : parseFloat(v);
                    return isNaN(n) ? 0 : n;
                }
                assumptions.ticket = readNumber('ass-ticket', false);
                assumptions.opPerClient = readNumber('ass-op', false);
                assumptions.fixed = readNumber('ass-fixed', false);
                assumptions.teamCost = readNumber('ass-team', false);
                assumptions.teamStart = readNumber('ass-team-start', true);
                assumptions.investAmount = readNumber('ass-invest', false);
                assumptions.investEnd = readNumber('ass-invest-end', true);
                assumptions.marketingAmount = readNumber('ass-marketing', false);
                assumptions.marketingStart = readNumber('ass-marketing-start', true);
                assumptions.marketingEnd = readNumber('ass-marketing-end', true);
                assumptions.clientsStart = readNumber('ass-clients-start', true) || 1;
                // client growth model inputs
                assumptions.clientsInit = readNumber('ass-clients-init', true) || 100;
                // allow 0 or small percentage values (do not coerce falsy 0 to default)
                assumptions.clientsGrowth = readNumber('ass-clients-growth', false);
                const gm = get('ass-clients-growth-mode');
                assumptions.clientsGrowthMode = gm ? !!gm.checked : true;
            }

            function showError(message){ const errBox = document.getElementById('all-error'); const errMsg = document.getElementById('all-error-msg'); if(errBox && errMsg){ errMsg.textContent = message; errBox.style.display = ''; } else console.error(message); }
        function clearAllInOne(){ const tbody = document.getElementById('all-tbody'); if(tbody) tbody.innerHTML = ''; const errBox = document.getElementById('all-error'); if(errBox) errBox.style.display = 'none'; }

            function runAllInOne(){
                try{
                    readAssumptionsFromUI(); clearAllInOne();
                    const tbody = document.getElementById('all-tbody');
                    const totalRevEl = document.getElementById('all-total-rev');
                    const totalOpEl = document.getElementById('all-total-op');
                    const totalFixedEl = document.getElementById('all-total-fixed');
                    const totalCostsEl = document.getElementById('all-total-costs');
                    const netEl = document.getElementById('all-net');

                    const ticket = assumptions.ticket; let opPerClient = assumptions.opPerClient; const fixed = assumptions.fixed;
                    if(typeof uiMode !== 'undefined' && uiMode === 'tms'){ opPerClient = 0; }
                    let totalRev=0, totalOp=0, totalFixed=0, totalCosts=0, totalNet=0; let totalInvest=0, totalTeam=0, totalMarketing=0;
                    const phaseAggs = phases.map(p => ({title:p.title, start:p.start, end:p.end, rev:0, invest:0, fixed:0, team:0, marketing:0, op:0, costs:0, net:0}));

                    let cumulativeNet = 0; let breakEvenMonth = null;

                    function insertPhaseHeader(title){
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.colSpan = 10; td.className='stage-header'; td.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; td.style.color='white'; td.style.fontSize='16px';
                        td.textContent = title; tr.appendChild(td); tbody.appendChild(tr);
                    }

                    // Ensure header visibility matches uiMode
                    try{
                        if(typeof uiMode !== 'undefined' && uiMode === 'tms'){
                            document.querySelectorAll('.th-op').forEach(el=> el.style.display='none');
                        } else {
                            document.querySelectorAll('.th-op').forEach(el=> el.style.display='');
                        }
                    } catch(e){}

                    for(let m=1;m<=60;m++){
                        phases.forEach(p => { if(m===p.start) insertPhaseHeader(p.title); });
                        const clients = interpClients(m);
                        const revenue = +(clients * ticket).toFixed(2);
                        const opCost = clients * opPerClient;
                        const invest = (m>=1 && m<=assumptions.investEnd) ? assumptions.investAmount : 0;
                        const teamCost = (m>=assumptions.teamStart) ? assumptions.teamCost : 0;
                        const marketingCost = (m>=assumptions.marketingStart && m<=assumptions.marketingEnd) ? assumptions.marketingAmount : 0;
                        const totalCost = fixed + opCost + invest + teamCost + marketingCost;
                        const result = +(revenue - totalCost).toFixed(2);

                        const cumBefore = cumulativeNet;
                        const cumAfter = +(cumulativeNet + result).toFixed(2);
                        let markRevenue = false;
                        if(breakEvenMonth===null){ if(cumBefore<0) markRevenue=true; if(cumAfter>=0){ markRevenue=true; breakEvenMonth=m; } }
                        cumulativeNet = cumAfter;

                        totalRev += revenue; totalOp += opCost; totalFixed += fixed; totalInvest += invest; totalTeam += teamCost; totalMarketing += marketingCost; totalCosts += totalCost; totalNet += result;

                        const phaseIndex = phases.findIndex(p => m>=p.start && m<=p.end);
                        if(phaseIndex>=0){ const agg = phaseAggs[phaseIndex]; agg.rev+=revenue; agg.invest+=invest; agg.fixed+=fixed; agg.team+=teamCost; agg.marketing+=marketingCost; agg.op+=opCost; agg.costs+=totalCost; agg.net+=result; }

                        const tr = document.createElement('tr'); if(m===1 || m%6===0) tr.classList.add('highlight');
                        const resClass = result>0 ? 'positive' : (result<0 ? 'negative' : 'neutral');
                        const isBreakMonth = (breakEvenMonth === m);
                        // build revenue classes and tooltip depending on pre-break / break status
                        const revStateClass = `${revenue>0 ? 'positive' : ''} ${markRevenue ? 'rev-prebreakeven' : ''} ${isBreakMonth ? 'rev-break' : ''}`.trim();
                        const revTitle = isBreakMonth ? 'Mês de break-even — receita cobre os investimentos' : (markRevenue ? 'Receita antes do break-even' : '');
                        // fixed costs tooltip breakdown (static labels as requested)
                        const fixedBreakdown = `Servidores ${fmt(750)} + Renda ${fmt(200)} + Contab. ${fmt(150)} + AI ${fmt(150)} = ${fmt(1250)}`;
                        const fixedCell = `<td class="num fixed-cell" data-tooltip="${fixedBreakdown}" title="${fixedBreakdown}">${fmt(fixed)}</td>`;
                        // operation cell: hide visually when in TMS mode but keep structure
                        const opCell = (typeof uiMode !== 'undefined' && uiMode === 'tms')
                            ? `<td class="num op-cell" data-tooltip="Custo de envios/Guias" title="Custo de envios/Guias" style="display:none">${fmt(opCost)}</td>`
                            : `<td class="num op-cell" data-tooltip="Custo de envios/Guias" title="Custo de envios/Guias">${fmt(opCost)}</td>`;
                        tr.innerHTML = `
                            <td class="metric">M${m}</td>
                            <td class="num">${clients}</td>
                            <td class="num ${revStateClass}" title="${revTitle}">${fmt(revenue)}</td>
                            <td class="num invest-cell" data-tooltip="Desenvolvimento da plataforma / website ${fmt(assumptions.investAmount)} x ${assumptions.investEnd} meses" title="Desenvolvimento da plataforma / website ${fmt(assumptions.investAmount)} x ${assumptions.investEnd} meses">${fmt(invest)}</td>
                            ${fixedCell}
                            <td class="num team-cell" data-tooltip="4 Membros — 2 Comerciais + 2 Apoio ao cliente" title="4 Membros — 2 Comerciais + 2 Apoio ao cliente">${fmt(teamCost)}</td>
                            <td class="num marketing-cell" data-tooltip="Contratação de Agências Especializadas" title="Contratação de Agências Especializadas">${fmt(marketingCost)}</td>
                            ${opCell}
                            <td class="num">${fmt(totalCost)}</td>
                            <td class="num ${resClass}">${result>=0? '+' : ''}${fmt(result)}</td>
                        `;
                        tbody.appendChild(tr);

                        // If this month is the end of a phase, insert an inline phase summary row right after it
                        const phaseIdx = phases.findIndex(p => m === p.end);
                        if(phaseIdx >= 0){
                            const a = phaseAggs[phaseIdx];
                            const summaryTr = document.createElement('tr');
                            const td = document.createElement('td');
                            td.colSpan = 10; td.style.padding = '10px';
                            const stateClass = (a.net >= 0) ? 'summary-positive' : 'summary-negative';
                            td.className = 'summary-box ' + stateClass;
                            td.innerHTML = `
                                <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
                                    <strong style="flex-basis:100%">${a.title} (M${a.start}-M${a.end})</strong>
                                    <span class="key-metric">Receita: <strong>${fmt(a.rev)}</strong></span>
                                    <span class="key-metric">Investimento: <strong>${fmt(a.invest)}</strong></span>
                                    <span class="key-metric">Custos Fixos: <strong>${fmt(a.fixed)}</strong></span>
                                    <span class="key-metric">Custos Equipa: <strong>${fmt(a.team)}</strong></span>
                                    <span class="key-metric">Marketing: <strong>${fmt(a.marketing)}</strong></span>
                                    ${(typeof uiMode !== 'undefined' && uiMode === 'tms') ? '' : `<span class="key-metric">Custos Operação: <strong>${fmt(a.op)}</strong></span>`}
                                    <span class="key-metric">Total Custos: <strong>${fmt(a.costs)}</strong></span>
                                    <span class="key-metric">Lucro Líquido: <strong class="${a.net>=0? 'positive' : 'negative'}">${a.net>=0? '+' : ''}${fmt(a.net)}</strong></span>
                                </div>
                            `;
                            summaryTr.appendChild(td);
                            tbody.appendChild(summaryTr);
                        }
                    }

                    // totals and summary
                    totalRev = +totalRev.toFixed(2); totalOp = +totalOp.toFixed(2); totalFixed = +totalFixed.toFixed(2); totalInvest = +totalInvest.toFixed(2); totalTeam = +totalTeam.toFixed(2); totalMarketing = +totalMarketing.toFixed(2); totalCosts = +totalCosts.toFixed(2); totalNet = +totalNet.toFixed(2);
                    if(totalRevEl) totalRevEl.textContent = fmt(totalRev);
                    if(totalOpEl) totalOpEl.textContent = fmt(totalOp);
                    if(totalFixedEl) totalFixedEl.textContent = fmt(totalFixed);
                    if(totalCostsEl) totalCostsEl.textContent = fmt(totalCosts);

                    if(netEl) netEl.textContent = (totalNet>=0? '+':'') + fmt(totalNet);
                    // make the accumulated net row more prominent and color-coded by sign
                    const netRow = netEl && netEl.closest('.summary-row');
                    if(netRow){
                        netRow.classList.add('net-prominent');
                        const metricEl = netRow.querySelector('.metric');
                        if(metricEl){
                            metricEl.classList.add('prominent');
                            metricEl.classList.remove('positive','negative');
                            metricEl.classList.add(totalNet>=0? 'positive' : 'negative');
                        }
                    }

                    // populate vertical summary fields
                    const investField = document.getElementById('all-total-invest');
                    const teamField = document.getElementById('all-total-team');
                    const marketingField = document.getElementById('all-total-marketing');
                    const breakField = document.getElementById('all-break');
                    if(investField) investField.textContent = fmt(totalInvest);
                    if(teamField) teamField.textContent = fmt(totalTeam);
                    if(marketingField) marketingField.textContent = fmt(totalMarketing);
                    if(breakField) breakField.textContent = breakEvenMonth ? ('Mês ' + breakEvenMonth) : 'Não atingido nos 60 meses';
                    // highlight the break row visually
                    const breakRow = breakField && breakField.closest('.summary-row');
                    if(breakRow){
                        if(breakEvenMonth){ breakRow.classList.add('break'); } else { breakRow.classList.remove('break'); }
                    }

                    // compute and display ROI = (totalNet / totalInvest) * 100
                    const roiField = document.getElementById('all-roi');
                    if(roiField){
                        let roiText = '-';
                        const roiRow = roiField.closest('.summary-row');
                        if(totalInvest && !isNaN(totalInvest) && totalInvest !== 0){
                            const roi = (totalNet / totalInvest) * 100;
                            const sign = roi >= 0 ? '+' : '';
                            roiText = sign + roi.toFixed(2) + ' %';
                            // color class on metric
                            roiField.parentElement.classList.remove('positive','negative');
                            roiField.parentElement.classList.add(roi>=0? 'positive' : 'negative');
                        } else {
                            roiText = 'N/A';
                            if(roiField.parentElement) roiField.parentElement.classList.remove('positive','negative');
                        }
                        roiField.textContent = roiText;
                        // give ROI row a subtle emphasis when positive
                        if(roiRow){
                            roiRow.classList.toggle('summary-positive', (totalInvest && totalNet>0));
                        }
                    }

                    // (phase summaries are inserted inline immediately after the last month row)

                    // prepare CSV export (assign, don't add multiple listeners)
                    const exportBtn = document.getElementById('export-csv');
                    if(exportBtn){
                        exportBtn.onclick = function(){
                            // Build headers and index map depending on uiMode
                            const fullHeaders = ['Mes','Clientes','Receita','Investimento','Custos Fixos','Custos Equipa','Marketing','Custos Operacao','Total Custos','Resultado'];
                            let headers = fullHeaders.slice();
                            let indices = headers.map((h,i)=>i);
                            if(typeof uiMode !== 'undefined' && uiMode === 'tms'){
                                // remove 'Custos Operacao' (index 7)
                                const removeAt = 7;
                                headers.splice(removeAt,1);
                                indices = headers.map(h => fullHeaders.indexOf(h));
                            }
                            const rows = [headers];
                            for(let r=0;r<tbody.rows.length;r++){
                                const cells = Array.from(tbody.rows[r].cells);
                                // map selected indices to cell text (if missing, fallback to '')
                                const cols = indices.map(idx => (cells[idx] ? String(cells[idx].textContent).replace(/\u00A0/g,' ') : ''));
                                rows.push(cols);
                            }
                            const csv = rows.map(r=> r.map(c=> '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
                            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a'); a.href = url; a.download = (uiMode === 'tms' ? 'tms-60-months.csv' : 'all-in-one-60-months.csv'); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                        };
                    }

                } catch(err){ showError(err.message || String(err)); }
            }

            function updateTmsSummaries(){
                try{
                    readAssumptionsFromUI();
                    const investTotal = assumptions.investAmount * assumptions.investEnd;
                    const marketingTotal = assumptions.marketingAmount * Math.max(0, (assumptions.marketingEnd - assumptions.marketingStart + 1));
                    const p = document.getElementById('tms-invest-platform');
                    const p2 = document.getElementById('tms-invest-platform-final');
                    const m = document.getElementById('tms-invest-marketing');
                    const m2 = document.getElementById('tms-invest-marketing-final');
                    if(p) p.innerHTML = '<strong>Investimento Plataforma:</strong> ' + fmt(investTotal);
                    if(p2) p2.innerHTML = '<strong>Investimento Plataforma:</strong> ' + fmt(investTotal);
                    if(m) m.innerHTML = '<strong>Investimento Marketing (M'+assumptions.marketingStart+'-M'+assumptions.marketingEnd+'):</strong> ' + fmt(marketingTotal);
                    if(m2) m2.innerHTML = '<strong>Investimento Marketing:</strong> ' + fmt(marketingTotal);
                } catch(e){ console.error(e); }
            }

            function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=> fn(...args), wait); }; }
            const inputs = ['ass-ticket','ass-op','ass-fixed','ass-team','ass-team-start','ass-invest','ass-invest-end','ass-marketing','ass-marketing-start','ass-marketing-end','ass-clients-start','ass-clients-init','ass-clients-growth','ass-clients-growth-mode'];
            const debounced = debounce(()=>{ runAllInOne(); updateTmsSummaries(); }, 220);

            document.addEventListener('DOMContentLoaded', ()=>{
                inputs.forEach(id => { const el = document.getElementById(id); if(el) el.addEventListener('input', debounced); });
                // Only All-in-One view remains. Wire the All-in-One button to ensure it's active and visible.
                const btnAll = document.getElementById('btn-all');
                if(btnAll) btnAll.addEventListener('click', ()=>{
                    document.getElementById('view-all').style.display='';
                    btnAll.classList.add('active');
                    // collapse all assumption groups when SaaS is clicked
                    try{
                        const groups = Array.from(document.querySelectorAll('.ass-group'));
                        groups.forEach(g => {
                            g.classList.add('collapsed');
                            const btn = g.querySelector('.collapse-btn');
                            if(btn) btn.setAttribute('aria-expanded','false');
                            const body = g.querySelector('.group-body');
                            if(body) body.style.maxHeight = '0px';
                            try{
                                const key = 'ass-group-' + (g.getAttribute('data-group') || g.querySelector('strong')?.textContent?.trim()?.toLowerCase()?.replace(/\s+/g,'-'));
                                localStorage.setItem(key, 'collapsed');
                            }catch(e){}
                        });
                    }catch(e){/* ignore */}
                });
                document.getElementById('btn-print').addEventListener('click', ()=> setTimeout(()=> window.print(), 100));

                

                // New view buttons: All in One and TMS (toggle active state)
                const btnViewAll = document.getElementById('btn-view-allinone');
                const btnViewTms = document.getElementById('btn-view-tms');
                function clearViewButtons(){ if(btnViewAll) btnViewAll.classList.remove('active'); if(btnViewTms) btnViewTms.classList.remove('active'); }
                if(btnViewAll){ btnViewAll.addEventListener('click', ()=>{ clearViewButtons(); btnViewAll.classList.add('active'); uiMode = 'all'; // enable op input and show column
                    const v = document.getElementById('view-all'); if(v) v.style.display=''; const opInput = document.getElementById('ass-op'); if(opInput) { opInput.disabled = false; }
                    document.body.classList.remove('mode-tms'); document.querySelectorAll('.th-op, .op-cell').forEach(el=> el.style.display='');
                    runAllInOne(); }); }
                if(btnViewTms){ btnViewTms.addEventListener('click', ()=>{ clearViewButtons(); btnViewTms.classList.add('active'); uiMode = 'tms'; // in TMS mode, disable op input and hide op column
                    const opInput = document.getElementById('ass-op'); if(opInput){ opInput.disabled = true; opInput.dataset._prev = opInput.value; opInput.value = '0'; }
                    document.body.classList.add('mode-tms'); document.querySelectorAll('.th-op').forEach(el=> el.style.display='none'); document.querySelectorAll('.op-cell').forEach(el=> el.style.display='none'); runAllInOne(); }); }

                // Collapsible assumption groups: wire buttons and persist state
                const groupEls = Array.from(document.querySelectorAll('.ass-group'));
                groupEls.forEach(g => {
                    const key = 'ass-group-' + (g.getAttribute('data-group') || g.querySelector('strong')?.textContent?.trim()?.toLowerCase()?.replace(/\s+/g,'-'));
                    const btn = g.querySelector('.collapse-btn');
                    const body = g.querySelector('.group-body');
                    // initialize max-height for smooth transitions (compute content height)
                    if(body){ body.style.maxHeight = (body.scrollHeight + 12) + 'px'; }
                    // restore collapsed state from localStorage; default to collapsed unless explicitly expanded
                    try{
                        const saved = localStorage.getItem(key);
                        const isExpanded = (saved === 'expanded');
                        if(!isExpanded){ g.classList.add('collapsed'); if(btn) btn.setAttribute('aria-expanded','false'); if(body) body.style.maxHeight = '0px'; }
                        else { if(btn) btn.setAttribute('aria-expanded','true'); if(body) body.style.maxHeight = (body.scrollHeight + 12) + 'px'; }
                    } catch(e){}
                    if(btn){ btn.addEventListener('click', ()=>{
                        const isCollapsed = g.classList.toggle('collapsed');
                        btn.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
                        try{ localStorage.setItem(key, isCollapsed ? 'collapsed' : 'expanded'); } catch(e){}
                        // adjust maxHeight to allow smooth expand
                        if(body){ if(!isCollapsed){ body.style.maxHeight = (body.scrollHeight + 12) + 'px'; } else { body.style.maxHeight = '0px'; } }
                    }); }
                });

                // initial generation
                runAllInOne(); updateTmsSummaries();
            });

        })();
        </script>

    </body>
    </html>
